# Подсистема "Сделки"

Добавить регистр накопления «Товары» вида «Остатки»
добавить измерение «Номенклатура» (СправочникСсылка.Номенклатура) и ресурсы «Сумма» (ОпределяемыйТип.Сумма) и «Количество» (ОпределяемыйТип.Количество).

![Регистр накопления](%D0%A0%D0%B5%D0%B3%D0%B8%D1%81%D1%82%D1%80%20%D0%BD%D0%B0%D0%BA%D0%BE%D0%BF%D0%BB%D0%B5%D0%BD%D0%B8%D1%8F.png)

Добавить регистр накопления «ВзаиморасчётыСКонтрагентами» вида «Остатки»:
добавить измерение «Контрагент» (СправочникСсылка.Контрагенты) и ресурс «Сумма» (ОпределяемыйТип.Сумма).

![Взаиморасчеты](%D0%92%D0%B7%D0%B0%D0%B8%D0%BC%D0%BE%D1%80%D0%B0%D1%81%D1%87%D0%B5%D1%82%D1%8B.png)

Добавить регистр накопления «Доходы» вида «Обороты»:
д«обавить измерение «Номенклатура» (СправочникСсылка.Номенклатура) и ресурсы «Сумма» (ОпределяемыйТип.Сумма) и «Количество» (ОпределяемыйТип.Количество).

![Доходы](%D0%94%D0%BE%D1%85%D0%BE%D0%B4%D1%8B.png)

Добавить регистр накопления «Расходы» вида «Обороты»:
добавить измерение «Номенклатура» (СправочникСсылка.Номенклатура) и ресурс «Сумма» (ОпределяемыйТип.Сумма).

![Расходы](%D0%A0%D0%B0%D1%81%D1%85%D0%BE%D0%B4%D1%8B.png)

Добавить общий модуль «НДСКлиентСервер»,с флагами «Клиент» и «Сервер»,
создать в нём функцию «СуммаНДСПоСтавке» (Сумма, СтавкаНДС), возвращающую сумму НДС, рассчитанную от суммы по ставке согласно требованиям. Чтобы обеспечить работоспособность на клиенте, для получения значений ставок НДС используйте функцию «ПредопределенноеЗначение()»

![НДС](%D0%9D%D0%94%D0%A1.png)

Добавить документ «ПоступлениеТоваровИУслуг»,добавить реквизиты «Поставщик»» (СправочникСсылка.Контрагенты) и «Сумма» (ОпределяемыйТип.Сумма),добавить ТЧ «ТоварыИУслуги» с реквизитами:
«Номенклатура» (СправочникСсылка.Номенклатура);
«Количество» (ОпределяемыйТип.Количество);
«СтавкаНДС» (ПеречислениеСсылка.СтавкиНДС);
«Цена», «Сумма», «СуммаНДС» (ОпределяемыйТип.Сумма);

![Поступление](%D0%9F%D0%BE%D1%81%D1%82%D1%83%D0%BF%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5.png)

в «Движениях» выбрать регистры накопления «Товары», «Расходы» и «ВзаиморасчётыСКонтрагентами»;

![Движения](%D0%94%D0%B2%D0%B8%D0%B6%D0%B5%D0%BD%D0%B8%D1%8F.png)

создать форму документа, в которой,разумным образом разместить элементы управления для реквизитов и табличных частей,в таблице товаров и услуг включить отображение подвала и вывести в него итог по колонкам «Сумма» и «Сумма НДС», поставив флаг «Отображать в подвале» и задав путь к данным подвала;

![Форма Документа](%D0%A4%D0%BE%D1%80%D0%BC%D0%B0%20%D0%94%D0%BE%D0%BA%D1%83%D0%BC%D0%B5%D0%BD%D1%82%D0%B0.png)

создать клиентские процедуры:
ПриИзмененииКоличества(ИзмененнаяСтрока), ПриИзмененииЦены(ИзмененнаяСтрока), в которых:
рассчитывать сумму по цене и количеству и вызывать ПриИзмененииСуммы();

 &НаКлиенте
 
 Процедура ПриИзмененииЦены(ИзмененнаяСтрока)
	  
		РаботаСДокументамиСумма.Сумма(ИзмененнаяСтрока);
		ПриИзмененииСуммы(ИзмененнаяСтрока);	
	
 КонецПроцедуры

 &НаКлиенте

 Процедура ПриИзмененииКоличества(ИзмененнаяСтрока)
	 
	 РаботаСДокументамиСумма.Сумма(ИзмененнаяСтрока);
	 ПриИзмененииСуммы(ИзмененнаяСтрока);
	
 КонецПроцедуры

 ПриИзмененииСуммы(ИзмененнаяСтрока), ПриИзмененииСтавкиНДС(ИзмененнаяСтрока), в которых рассчитывать сумму НДС по сумм и ставке вызовом НДСКлиентСервер.СуммаНДСПоСтав();

 &НаКлиенте

 Процедура ПриИзмененииСуммы(ИзмененнаяСтрока) 
	 
	 ИзмененнаяСтрока.СуммаНДС = НДСКлиентСервер.СуммаНдсПоСтавке(ИзмененнаяСтрока.Сумма, ИзмененнаяСтрока.СтавкаНдс);

 КонецПроцедуры

 &НаКлиенте

 Процедура ПриИзмененииСтавкиНдс(ИзмененнаяСтрока) 
	 
	 Сумма = ИзмененнаяСтрока.Сумма;
	 СтавкаНдс = ИзмененнаяСтрока.СтавкаНдс;
	 ИзмененнаяСтрока.СуммаНДС =  НДСКлиентСервер.СуммаНдсПоСтавке(Сумма,СтавкаНдс);
	  
 КонецПроцедуры

 переопределить обработчики событий ПриИзменении полей ввода для количества, цены, суммы и ставки НДС и вызывать из них процедуры ПриИзменении<...>, передавая в качестве параметра «ТекущиеДанные» таблицы;

 &НаКлиенте

 Процедура ТоварыИУслугиЦенаПриИзменении(Элемент) 
	 
	 ИзмененнаяСтрока = Элементы.ТоварыИУслуги.ТекущиеДанные;
	 ПриИзмененииЦены(ИзмененнаяСтрока);
	 
 КонецПроцедуры

 &НаКлиенте

 Процедура ТоварыИУслугиКоличествоПриИзменении(Элемент)
	 
	 ИзмененнаяСтрока = Элементы.ТоварыИУслуги.ТекущиеДанные;
	 ПриИзмененииКоличества(ИзмененнаяСтрока);
	 
 КонецПроцедуры

 &НаКлиенте

 Процедура ТоварыИУслугиСуммаПриИзменении(Элемент)
	 
	 ИзмененнаяСтрока = Элементы.ТоварыИУслуги.ТекущиеДанные;
	 ПриИзмененииСуммы(ИзмененнаяСтрока);
	 
 КонецПроцедуры

 &НаКлиенте
 Процедура ТоварыИУслугиСтавкаНДСПриИзменении(Элемент)
	 
	 ИзмененнаяСтрока = Элементы.ТоварыИУслуги.ТекущиеДанные;
	 ПриИзмененииСтавкиНдс(ИзмененнаяСтрока);
	 
 КонецПроцедуры

 В модуле объекта:
создать обработчик события «ОбработкаПроведения» и формировать движения, выбрав предварительно запросом табличную часть с типами номенклатуры:
по регистру «ВзаиморасчётыСКонтрагентами» — одно движение вида «Расход» с указанием контрагента-поставщика и общей суммы;
по регистру «Товары» — движения вида «Приход» по каждой строке с номенклатурой типа «Товары» с указанием номенклатуры, количества и суммы;
по регистру ««Расходы» — движения по каждой строке с номенклатурой типа «Услуги» с указанием номенклатуры и суммы;

Процедура ОбработкаПроведения(Отказ, Режим)

	Движения.Товары.Записывать = Истина;
	Движения.ВзаиморасчетыСКонтрагентами.Записывать = Истина;
	Движения.Расходы.Записывать = Истина;
		
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	СУММА(ПоступлениеТоваровИУслугТоварыИУслуги.Количество) КАК Количество,
		|	СУММА(ПоступлениеТоваровИУслугТоварыИУслуги.Цена) КАК Цена,
		|	СУММА(ПоступлениеТоваровИУслугТоварыИУслуги.Сумма) КАК Сумма,
		|	ПоступлениеТоваровИУслугТоварыИУслуги.Номенклатура КАК Номенклатура
		|ИЗ
		|	Документ.ПоступлениеТоваровИУслуг.ТоварыИУслуги КАК ПоступлениеТоваровИУслугТоварыИУслуги
		|ГДЕ
		|	ПоступлениеТоваровИУслугТоварыИУслуги.Ссылка = &Ссылка
		|
		|СГРУППИРОВАТЬ ПО
		|	ПоступлениеТоваровИУслугТоварыИУслуги.Номенклатура";
	
	Запрос.УстановитьПараметр("Ссылка", Ссылка);
	
	Результат = Запрос.Выполнить().Выгрузить();
	
	Движение = Движения.ВзаиморасчетыСКонтрагентами.Добавить();
	Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
	Движение.Период = Дата;
	Движение.Контрагент = Ссылка.Поставщик;
	Движение.Сумма = Ссылка.Сумма;
		
	Для Каждого Строка Из Результат Цикл
			
			Движение = Движения.Товары.Добавить();
			Движение.ВидДвижения = ВидДвиженияНакопления.Приход;
			Движение.Период = Дата;
			Движение.Номенклатура = Строка.Номенклатура;
			Движение.Количество = Строка.Количество;
			Движение.Сумма = Строка.Сумма;
			
			Если Строка.Номенклатура.Тип = Перечисления.ТипыНоменклатуры.Услуга Тогда
			Движение = Движения.Расходы.Добавить();
			Движение.Период = Дата;
			Движение.Номенклатура = Строка.Номенклатура;
			Движение.Сумма = Строка.Сумма;
			КонецЕсли;
		КонецЦикла;
		
КонецПроцедуры

Создать обработчик события «ПередЗаписью» и сохранять в реквизит шапки «Сумма» итог по одноимённому реквизиту табличной части для отображения в списках;

Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
	
	Сумма = ТоварыИУслуги.Итог("Сумма");
	
КонецПроцедуры

Добавить документ «РеализацияТоваровИУслуг»,добавить реквизиты «Покупатель» (СправочникСсылка.Контрагенты) и «Сумма» (ОпределяемыйТип.Сумма),добавить ТЧ «ТоварыИУслуги» с реквизитами:
«Номенклатура» (СправочникСсылка.Номенклатура);
«Количество» (ОпределяемыйТип.Количество);
«СтавкаНДС» (ПеречислениеСсылка.СтавкиНДС);
«Скидка» (Число);
«Цена», «Сумма», «СуммаНДС» (ОпределяемыйТип.Сумма);

![Реализация](%D0%A0%D0%B5%D0%B0%D0%BB%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F.png)

Создать форму документа, в которой:
разумным образом разместить элементы управления для реквизитов и табличных частей;
в таблице товаров и услуг включить отображение подвала и вывести в него итог по колонкам «Сумма" и «Сумма НДС";
создать клиентскую функцию «СуммаПоСтроке» (Строка), которая возвращает сумму с учётом количества, цены и скидки;

![Форма реализации](%D0%A4%D0%BE%D1%80%D0%BC%D0%B0%20%D1%80%D0%B5%D0%B0%D0%BB%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D0%B8.png)

Создать клиентскую функцию «СуммаПоСтроке» (Строка), которая возвращает сумму с учётом количества, цены и скидки;

&НаКлиенте

Функция СуммаПоСтроке(ИзмененнаяСтрока)
	
	ИзмененнаяСтрока.Сумма = ИзмененнаяСтрока.Количество * ИзмененнаяСтрока.Цена * (100 - ИзмененнаяСтрока.Скидка) / 100;
	
КонецФункции

создать клиентские процедуры:
ПриИзмененииНоменклатуры(ИзмененнаяСтрока), в которой:
заполнять цену и скидку, а также заполнять ставку НДС и вызывать процедуры «ПриИзмененииЦены», «ПриИзмененииСкидки» и «ПриИзмененииСтавкиНДС»;

&НаКлиенте

Процедура ПриИзмененииНоменклатуры(ИзмененнаяСтрока) 
			
	Номенклатура = ИзмененнаяСтрока.Номенклатура;
	Дата = Объект.Дата;
	ИзмененнаяСтрока.Цена = ЦеныВызовСервера.ЦенаНаДату(Номенклатура, Дата);
	ИзмененнаяСтрока.Скидка = ЦеныВызовСервера.СкидкаНаДату(Номенклатура,Дата);
	
	Сумма = ИзмененнаяСтрока.Сумма;
	СтавкаНДС = ИзмененнаяСтрока.СтавкаНДС;
	ИзмененнаяСтрока.СтавкаНДС = НДСКлиентСервер.СуммаНдсПоСтавке(Сумма,СтавкаНДС);
	
	ПриИзмененииЦены(ИзмененнаяСтрока); 
	ПриИзмененииСкидки(ИзмененнаяСтрока);
	ПриИзмененииСтавкиНДС(ИзмененнаяСтрока);
	
КонецПроцедуры

ПриИзмененииКоличества(ИзмененнаяСтрока), ПриИзмененииЦены(ИзмененнаяСтрока), ПриИзмененииСкидки(ИзмененнаяСтрока), в которых:
рассчитывать сумму вызовом «СуммаПоСтроке()» и вызывать «ПриИзмененииСуммы()»;

&НаКлиенте

Процедура ПриИзмененииКоличества(ИзмененнаяСтрока) 
			
	СуммаПоСтроке(ИзмененнаяСтрока);
	ПриИзмененииСуммы(ИзмененнаяСтрока);
	
КонецПроцедуры

&НаКлиенте

Процедура ПриИзмененииЦены(ИзмененнаяСтрока) 
			
	СуммаПоСтроке(ИзмененнаяСтрока);
	ПриИзмененииСуммы(ИзмененнаяСтрока);
	
КонецПроцедуры

&НаКлиенте

Процедура ПриИзмененииСкидки(ИзмененнаяСтрока) 
			
	СуммаПоСтроке(ИзмененнаяСтрока);
	ПриИзмененииСуммы(ИзмененнаяСтрока);
	
КонецПроцедуры

ПриИзмененииСуммы(ИзмененнаяСтрока), ПриИзмененииСтавкиНДС(ИзмененнаяСтрока),в которых:
рассчитывать сумму НДС по сумме и ставке вызовом «НДСКлиентСервер.СуммаНДСПоСтавке()»;

&НаКлиенте

Процедура ПриИзмененииСуммы(ИзмененнаяСтрока)

 Сумма = ИзмененнаяСтрока.Сумма;
 СтавкаНДС = ИзмененнаяСтрока.СтавкаНДС;
 НДСКлиентСервер.СуммаНдсПоСтавке(Сумма,СтавкаНДС);

КонецПроцедуры

&НаКлиенте

Процедура ПриИзмененииСтавкиНДС(ИзмененнаяСтрока)

	Сумма = ИзмененнаяСтрока.Сумма;
	СтавкаНДС = ИзмененнаяСтрока.СтавкаНДС;
	ИзмененнаяСтрока.СуммаНДС = НДСКлиентСервер.СуммаНдсПоСтавке(Сумма,СтавкаНДС);

КонецПроцедуры

Переопределить обработчики событий ПриИзменении полей ввода номенклатуры, количества, цены, скидки, суммы и ставки НДС, и вызывать из них процедуры ПриИзменении<...>, передавая в качестве параметра «ТекущиеДанные таблицы»;

&НаКлиенте

Процедура ТоварыНоменклатураПриИзменении(Элемент)
	
	ИзмененнаяСтрока = Элементы.Товары.ТекущиеДанные;
	ПриИзмененииНоменклатуры(ИзмененнаяСтрока);
	
КонецПроцедуры

&НаКлиенте

Процедура ТоварыКоличествоПриИзменении(Элемент)
	
	ИзмененнаяСтрока = Элементы.Товары.ТекущиеДанные;	
	ПриИзмененииКоличества(ИзмененнаяСтрока);
	
КонецПроцедуры

&НаКлиенте

Процедура ТоварыЦенаПриИзменении(Элемент)
	
	ИзмененнаяСтрока = Элементы.Товары.ТекущиеДанные;	
	ПриИзмененииЦены(ИзмененнаяСтрока);
	
КонецПроцедуры

&НаКлиенте

Процедура ТоварыСкидкаПриИзменении(Элемент)
	
	ИзмененнаяСтрока = Элементы.Товары.ТекущиеДанные;	
	ПриИзмененииСкидки(ИзмененнаяСтрока); 
	
КонецПроцедуры

&НаКлиенте

Процедура ТоварыСуммаПриИзменении(Элемент)
	
	ИзмененнаяСтрока = Элементы.Товары.ТекущиеДанные;	
	ПриИзмененииСуммы(ИзмененнаяСтрока); 
	
КонецПроцедуры

&НаКлиенте

Процедура ТоварыСтавкаНДСПриИзменении(Элемент)
	
	ИзмененнаяСтрока = Элементы.Товары.ТекущиеДанные;	
	ПриИзмененииСтавкиНДС(ИзмененнаяСтрока); 

КонецПроцедуры

Реализовать подбор аналогично документу «УстановкаЦен», передавая в качестве владельца открываемой формы таблицу «ТоварыИУслуги», а в обработчике события «ОбработкаВыбора» вызывая процедуру «ПриИзмененииНоменклатуры», чтобы обеспечить получение цен и скидок и автоматический пересчёт сумм;

&НаКлиенте

Процедура Подбор(Команда) 
	
	Параметр = Новый Структура("ЗакрыватьПриВыборе",Ложь,);
	ОткрытьФорму("Справочник.Номенклатура.ФормаВыбора",Параметр,Элементы.Товары);
	   
КонецПроцедуры

&НаКлиенте

Процедура ТоварыОбработкаВыбора(Элемент, ВыбранноеЗначение, СтандартнаяОбработка)
	   
	   СтандартнаяОбработка = Ложь;
	   
	   ЭлементВыбора = Новый Структура;
	   ЭлементВыбора.Вставить("Номенклатура",ВыбранноеЗначение);
	   Результат = Объект.Товары.НайтиСтроки(ЭлементВыбора);
	   
	   Если Результат.Количество() = 0 Тогда 
		   ИзмененнаяСтрока= Объект.Товары.Добавить();
		   ИзмененнаяСтрока.Номенклатура = ВыбранноеЗначение;
		   ПриИзмененииНоменклатуры(ИзмененнаяСтрока);
	   КонецЕсли; 
	   
   КонецПроцедуры

В модуле объекта:
создать обработчик события «ОбработкаПроведения» и формировать движения, выбрав предварительно запросом данные табличной части документа с типами номенклатуры и соединив с виртуальной таблицей Остатки регистра «Товары» по номенклатуре:
по регистру «ВзаиморасчётыСКонтрагентами» — одно движение вида «Приход» с указанием контрагента-покупателя и общей суммы;
по регистру товары — движения вида «Расход» по каждой строке с номенклатурой типа «Товары» с указанием номенклатуры, количества и суммы. Сумму рассчитывать, определив среднюю стоимость единицы делением суммы остатка на количество остатка и умножив среднюю стоимость на реализуемое количество. При нехватке остатков отказываться от проведения, выводя пользователю разумное сообщение;
по регистру «Расходы» — движения по каждой строке с номенклатурой типа «Товары» с указанием номенклатуры и суммы, равной сумме расхода по регистру «Товары»;
по регистру «Доходы» — движения по каждой строке с указанием номенклатуры, количества и суммы;

Процедура ОбработкаПроведения(Отказ, Режим)
	 
	//НоваяЗапись
	Движения.Товары.Записывать = Истина; 
	Движения.ВзаиморасчетыСКонтрагентами.Записывать=Истина;
	Движения.Доходы.Записывать=Истина;
	Движения.Расходы.Записывать=Истина;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	РеализацияТоваровИУслугТовары.Номенклатура КАК Номенклатура,
	|	СУММА(РеализацияТоваровИУслугТовары.Количество) КАК Количество
	|ПОМЕСТИТЬ ВТ_Товары
	|ИЗ
	|	Документ.РеализацияТоваровИУслуг.Товары КАК РеализацияТоваровИУслугТовары
	|ГДЕ
	|	РеализацияТоваровИУслугТовары.Ссылка = &Ссылка
	|
	|СГРУППИРОВАТЬ ПО
	|	РеализацияТоваровИУслугТовары.Номенклатура
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ_Товары.Номенклатура КАК Номенклатура,
	|	ВТ_Товары.Количество КАК Количество,
	|	ЕСТЬNULL(ТоварыОстатки.КоличествоОстаток, 0) КАК КоличествоОстаток,
	|	ЕСТЬNULL(ТоварыОстатки.СуммаОстаток, 0) КАК СуммаОстаток,
	|	ВТ_Товары.Номенклатура.Представление КАК НоменклатураПредставление
	|ИЗ
	|	ВТ_Товары КАК ВТ_Товары
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.Товары.Остатки(
	|				&МоментВремени,
	|				Номенклатура В
	|					(ВЫБРАТЬ
	|						ВТ_Товары.Номенклатура КАК Номенклатура
	|					ИЗ
	|						ВТ_Товары КАК ВТ_Товары)) КАК ТоварыОстатки
	|		ПО ВТ_Товары.Номенклатура = ТоварыОстатки.Номенклатура";
	
	
	Запрос.УстановитьПараметр("МоментВремени", МоментВремени());
	Запрос.УстановитьПараметр("Ссылка", Ссылка);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Выборка = РезультатЗапроса.Выбрать();
	
	
	Движение = Движения.ВзаиморасчетыСКонтрагентами.Добавить();
	Движение.ВидДвижения = ВидДвиженияНакопления.Приход; 
	Движение.Период = Дата;
	Движение.Контрагент =Ссылка.Покупатель;
	Движение.Сумма = Ссылка.Сумма; 
	
	Пока Выборка.Следующий() Цикл 
		
		Если Выборка.Количество > Выборка.КоличествоОстаток Тогда 
			Сообщение = Новый СообщениеПользователю;
			Сообщение.Текст = " Не хватает товара  "  +  Выборка.НоменклатураПредставление  +  "  в количестве "  +  ( Выборка.Количество - Выборка.КоличествоОстаток);
			Сообщение.Сообщить();
			
			Отказ = Истина;
			Продолжить;
		КонецЕсли;
				
		Если Выборка.Количество = Выборка.КоличествоОстаток Тогда
			
			Себестоимость = Выборка.СуммаОстаток;
		Иначе
			Себестоимость = Выборка.СуммаОстаток  /  Выборка.КоличествоОстаток * Выборка.Количество  ;
			
		КонецЕсли;
		Движение = Движения.Товары.Добавить();
		Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
		Движение.Период = Дата;
		Движение.Номенклатура = Выборка.Номенклатура;
		Движение.Количество =Выборка.Количество;
		Движение.Сумма = Себестоимость; 
		
		Если Выборка.Номенклатура.Тип = Перечисления.ТипыНоменклатуры.Товар Тогда
			Движение = Движения.Расходы.Добавить();
			Движение.Период = Дата;
			Движение.Номенклатура = Выборка.Номенклатура;
			Движение.Сумма = Сумма;
		КонецЕсли;
		
		Движение = Движения.Доходы.Добавить();
		Движение.Период = Дата;
		Движение.Номенклатура = Выборка.Номенклатура;
		Движение.Количество =Выборка.Количество;
		Движение.Сумма = Сумма;
		
		
	КонецЦикла; 

КонецПроцедуры

Добавить журнал документов «Сделки»,в качестве регистрируемых выбрать документы «ПоступлениеТоваровИУслуг» и «РеализацияТоваровИУслуг»,добавить графы «Контрагент», «Поставщик» из «Поступления» и «Покупатель» из «Реализации», «Ответственный» и «Сумма».

![Сделки](%D0%A1%D0%B4%D0%B5%D0%BB%D0%BA%D0%B8.png)