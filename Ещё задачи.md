# Подсистема "Настройки"
Все добавляемые объекты включаем в подсистему «Настройка»

![Подсистема Настройки](%D0%9F%D0%BE%D0%B4%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D0%B0%20%D0%9D%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B8.png)

Добавить перечисление «ТипыНоменклатуры» («Товар», «Услуга»);

![Типы номенклатуры](%D0%A2%D0%B8%D0%BF%D1%8B%20%D0%BD%D0%BE%D0%BC%D0%B5%D0%BD%D0%BA%D0%BB%D0%B0%D1%82%D1%83%D1%80%D1%8B.png)

С перечислением «СтавкиНДС» («БезНДС», «НДС10», «НДС20»);

![Ставки Ндс](%D0%A1%D1%82%D0%B0%D0%B2%D0%BA%D0%B8%20%D0%9D%D0%B4%D1%81.png)

С справочником «НоменклатурныеГруппы»
    без иерархии, с наименованием разумной длины;
    ![Номенклатурные группы](%D0%9D%D0%BE%D0%BC%D0%B5%D0%BD%D0%BA%D0%BB%D0%B0%D1%82%D1%83%D1%80%D0%BD%D1%8B%D0%B5%20%D0%B3%D1%80%D1%83%D0%BF%D0%BF%D1%8B.png)

Добавить справочник «Номенклатура»убрать код, дать разумную длину наименованию;
включить иерархию групп и элементов,добавить реквизиты, включив в «Проверке заполнения» вариант «Выдавать ошибку» и поставив флаг «Заполнять из данных заполнения»:
тип — ПеречислениеСсылка.ТипыНоменклатуры;
номенклатурнаяГруппа — СправочникСсылка.НоменклатурныеГруппы;
ставкаНДС — ПеречислениеСсылка.СтавкиНДС;

![Реквизиты](%D0%A0%D0%B5%D0%BA%D0%B2%D0%B8%D0%B7%D0%B8%D1%82%D1%8B.png)

в модуле объекта переопределить событие «ОбработкаЗаполнения», заполнив тип и ставку НДС значениями по умолчанию: «Товар», «НДС20». Заполнять только для элемента, для группы эти реквизиты не определены;

Процедура ОбработкаЗаполнения(ДанныеЗаполнения, ТекстЗаполнения, СтандартнаяОбработка) 
	
	СтандартнаяОбработка = Ложь;
	
	Если ЭтотОбъект.ЭтоГруппа = Ложь  Тогда
		Тип = Перечисления.ТипыНоменклатуры.Товар;
		СтавкаНДС = Перечисления.СтавкиНДС.НДС20;
	КонецЕсли;	

КонецПроцедуры

Добавить регистр сведений «Цены» установить периодичность «По позиции регистратора» и режим записи «Подчинение регистратору»;
добавить измерение «Номенклатура» (СправочникСсылка.Номенклатура) с флагом «Ведущее» и ресурс «Цена» (ОпределяемыйТип.Сумма);

![Регистр сведений](%D0%A0%D0%B5%D0%B3%D0%B8%D1%81%D1%82%D1%80%20%D1%81%D0%B2%D0%B5%D0%B4%D0%B5%D0%BD%D0%B8%D0%B9.png)

![Свойства](%D0%A1%D0%B2%D0%BE%D0%B9%D1%81%D1%82%D0%B2%D0%B0.png)
 
добавить общий модуль «ЦеныСервер» с флажками «Сервер» и «Внешнее соединение» и создать в нём экспортную функцию «ЦенаНаДату»(Номенклатура, Дата), которая получит запросом срез последних на указанную дату с отбором по номенклатуре и вернёт цену;

# Решение
Функция ЦеныНаДату(Номенклатура,Дата) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ЦеныСрезПоследних.Номенклатура КАК Номенклатура,
		|	ЦеныСрезПоследних.Цена КАК Цена
		|ИЗ
		|	РегистрСведений.Цены.СрезПоследних(
		|			&Период,
		|			Номенклатура В
		|				(ВЫБРАТЬ
		|					ЦеныСрезПоследних.Номенклатура КАК Номенклатура
		|				ИЗ
		|					РегистрСведений.Цены.СрезПоследних КАК ЦеныСрезПоследних
		|				ГДЕ
		|					ЦеныСрезПоследних.Номенклатура = &Номенклатура)) КАК ЦеныСрезПоследних";
	
	Запрос.УстановитьПараметр("Номенклатура", Номенклатура);
	Запрос.УстановитьПараметр("Период", Дата);
	
  Результат = Запрос.Выполнить();
       
    Выборка = Результат.Выбрать();

	Пока Выборка.Следующий() Цикл
		
		Цена = Выборка.Цена;
	
	КонецЦикла; 
	
	Возврат Цена;
КонецФункции

добавить общий модуль «ЦеныВызовСервера» с флажками «Сервер», «Внешнее соединение» и «Вызов сервера» и создать в нём функцию «ЦенаНаДату» для вызова из клиентского кода форм, которая вызовет одноимённую функцию из модуля «ЦеныСервер».
# Решение
Функция ЦенаНаДату(Номенклатура,Дата) Экспорт

Возврат ЦеныСервер.ЦеныНаДату(Номенклатура,Дата);	

КонецФункции
  
Добавить документ «УстановкаЦен»:
добавить ТЧ «Цены» с реквизитами «Номенклатура» (СправочникСсылка.Номенклатура) и «Цена» (ОпределяемыйТип.Сумма);

![Установка цен](%D0%A3%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0%20%D1%86%D0%B5%D0%BD.png)

в модуле объекта переопределить событие «ОбработкаПроведения», формируя движения по регистру сведений «Цены» датой документа;

Процедура ОбработкаПроведения(Отказ, Режим)
	
	Движения.Цены.Записывать = Истина;	
	Для Каждого ТекСтрокаЦены Из Цены Цикл	
		Движение = Движения.Цены.Добавить();
		Движение.Период = Дата;
		Движение.Номенклатура = ТекСтрокаЦены.Номенклатура;
		Движение.Цена = ТекСтрокаЦены.Цена;
	КонецЦикла;
	
КонецПроцедуры
   
создать клиентскую процедуру ПриИзмененииНоменклатуры с параметром «ИзмененнаяСтрока» (ДанныеФормыЭлементКоллекции), в которой, если Номенклатура заполнена, вызвать «ЦеныВызовСервера.ЦенаНаДату» и заполнить цену;

&НаКлиенте
Процедура ПриИзмененииНоменклатуры(ИзмененнаяСтрока) 
	
	Если ЗначениеЗаполнено(ИзмененнаяСтрока.Номенклатура) Тогда
		
		Номенклатура = ИзмененнаяСтрока.Номенклатура;
		Дата = Объект.Дата;
		ЦенаНоменклатуры = ЦеныВызовСервера.ЦенаНаДату(Номенклатура, Дата);
		ИзмененнаяСтрока.Цена = ЦенаНоменклатуры;
		
	КонецЕсли;
	
КонецПроцедуры

переопределить событие «ПриИзменении» поля ввода номенклатуры и вызвать в нём процедуру «ПриИзмененииНоменклатуры» с передачей текущих данных таблицы цен;

&НаКлиенте
Процедура ЦеныНоменклатураПриИзменении(Элемент) 
	   
	ИзмененнаяСтрока = Элементы.Цены.ТекущиеДанные;
	ПриИзмененииНоменклатуры(ИзмененнаяСтрока);
	   
   КонецПроцедуры

добавить команду «Подбор», разместив её в командной панели таблицы цен. В обработчике команды открыть форму выбора справочника «Номенклатура» с параметром «ЗакрыватьПриВыборе = Ложь», указав в качестве владельца таблицу цен;

&НаКлиенте
Процедура Подбор(Команда) 
	
	Параметр = Новый Структура("ЗакрыватьПриВыборе",Ложь,);
	ОткрытьФорму("Справочник.Номенклатура.ФормаВыбора",Параметр,Элементы.Цены);
	   
   КонецПроцедуры

переопределить событие «ОбработкаВыбора» таблицы цен. В обработчике отказаться от стандартной обработки и, если в таблице ещё нет выбранного значения, добавить строку и вызвать процедуру «ПриИзмененииНоменклатуры», передав добавленную строку;

&НаКлиенте
Процедура ЦеныОбработкаВыбора(Элемент, ВыбранноеЗначение, СтандартнаяОбработка)
	   
	   СтандартнаяОбработка = Ложь;
	   
	   ЭлементВыбора = Новый Структура;
	   ЭлементВыбора.Вставить("Номенклатура",ВыбранноеЗначение);
	   Результат = Объект.Цены.НайтиСтроки(ЭлементВыбора);
	   
	   Если Результат.Количество() = 0 Тогда 
		   ИзмененнаяСтрока= Объект.Цены.Добавить();
		   ИзмененнаяСтрока.Номенклатура = ВыбранноеЗначение;
		   ПриИзмененииНоменклатуры(ИзмененнаяСтрока);
	   КонецЕсли; 
	   
   КонецПроцедуры
      
Добавить регистр сведений «Скидки»,установить периодичность «По позиции регистратора» и режим записи «Подчинение регистратору»
![Скидки](%D0%A1%D0%BA%D0%B8%D0%B4%D0%BA%D0%B8.png)

в общий модуль «ЦеныСервер» добавить экспортную функцию «СкидкаНаДату» (Номенклатура, Дата), которая получит запросом срез последних на указанную дату с отбором по номенклатуре и номенклатурной группе и вернёт скидку, установленную для номенклатурной группы, если нет скидки для конкретной номенклатуры. В общий модуль ЦеныВызовСервера» добавить одноимённую функцию-обёртку.

# Решение
Функция СкидкаНаДату(Номенклатура,Дата) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	СкидкиСрезПоследних.НоменклатураНоменклатурнныеГруппы КАК Номенклатура,
		|	СкидкиСрезПоследних.Скидка КАК Скидка
		|ПОМЕСТИТЬ ВТ_Ном
		|ИЗ
		|	РегистрСведений.Скидки.СрезПоследних(&Дата, ) КАК СкидкиСрезПоследних
		|ГДЕ
		|	СкидкиСрезПоследних.НоменклатураНоменклатурнныеГруппы ССЫЛКА Справочник.Номенклатура
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	СкидкиСрезПоследних.НоменклатураНоменклатурнныеГруппы КАК НоменклатурннаяГруппа,
		|	СкидкиСрезПоследних.Скидка КАК Скидка
		|ПОМЕСТИТЬ ВТ_НомГруппа
		|ИЗ
		|	РегистрСведений.Скидки.СрезПоследних(&Дата, ) КАК СкидкиСрезПоследних
		|ГДЕ
		|	СкидкиСрезПоследних.НоменклатураНоменклатурнныеГруппы ССЫЛКА Справочник.НоменклатурныеГруппы";
	
	Запрос.УстановитьПараметр("Дата", Дата);
	
	Результат = Запрос.Выполнить();
	
	Ном= Запрос.МенеджерВременныхТаблиц.Таблицы[0].ПолучитьДанные().Выгрузить();
	НомГруппа = Запрос.МенеджерВременныхТаблиц.Таблицы[1].ПолучитьДанные().Выгрузить();
	
	МассивСкидок = Ном.НайтиСтроки(Новый Структура("Номенклатура", Номенклатура));
	
	Если МассивСкидок.Количество() > 0 Тогда
		Скидка = МассивСкидок[0].Скидка;
		
	Иначе
		Если Не ЗначениеЗаполнено(Справочники.НоменклатурныеГруппы.НайтиПоНаименованию(Номенклатура)) Тогда
			
			МассивСкидок = НомГруппа.НайтиСтроки(Новый Структура("НоменклатурннаяГруппа",  Номенклатура.НоменклатурнаяГруппа));
			
			Если МассивСкидок.Количество() > 0 Тогда
				Скидка = МассивСкидок[0].Скидка;	
			КонецЕсли;	 
		КонецЕсли;	 
	КонецЕсли;
	Возврат Скидка;
КонецФункции

Добавить документ «УстановкаСкидок»,добавить ТЧ «Скидки» с реквизитами «НоменклатураНоменклатурнаяГруппа» (СправочникСсылка.Номенклатура, СправочникСсылка.НоменклатурныеГруппы) и «Скидка» (Число);

![Скидки](%D0%A1%D0%BA%D0%B8%D0%B4%D0%BA%D0%B8.png)

в модуле объекта переопределить событие «ОбработкаПроведения», формируя движения по регистру сведений «Скидки» датой документа

Процедура ОбработкаПроведения(Отказ, Режим)

	// регистр Скидки
	Движения.Скидки.Записывать = Истина;
	Для Каждого ТекСтрокаСкидки Из Скидки Цикл
		Движение = Движения.Скидки.Добавить();
		Движение.Период = Дата;
		Движение.НоменклатураНоменклатурнныеГруппы = ТекСтрокаСкидки.НоменклатураНоменклатурнаяГруппа;
		Движение.Скидка = ТекСтрокаСкидки.Скидки;
	КонецЦикла;

КонецПроцедуры

создать клиентскую процедуру «ПриИзмененииНоменклатурыНоменклатурнойГруппы» с параметром «ИзмененнаяСтрока» (ДанныеФормыЭлементКоллекции), в которой, если «НоменклатураНоменклатурнаяГруппа» заполнена, вызвать «ЦеныВызовСервера.СкидкаНаДату» и заполнить скидку;

&НаКлиенте
Процедура ПриИзмененииНоменклатураНоменклатурнаяГруппа(ИзмененнаяСтрока) 
	
	Если ЗначениеЗаполнено(ИзмененнаяСтрока.НоменклатураНоменклатурнаяГруппа) Тогда
		
		Номенклатура = ИзмененнаяСтрока.НоменклатураНоменклатурнаяГруппа;
		Дата = Объект.Дата;
		СкидкаНоменклатураНоменклатурнаяГруппа = ЦеныВызовСервера.СкидкаНаДату(Номенклатура, Дата);
		ИзмененнаяСтрока.Скидки = СкидкаНоменклатураНоменклатурнаяГруппа;
		
	КонецЕсли;
	
КонецПроцедуры

переопределить событие «ПриИзменении поля ввода номенклатуры / номенклатурной группы» и вызвать в нём процедуру «ПриИзмененииНоменклатурыНоменклатурнойГруппы» с передачей текущих данных таблицы скидок;

&НаКлиенте
Процедура СкидкиНоменклатураНоменклатурнаяГруппаПриИзменении(Элемент)
	
	   ИзмененнаяСтрока = Элементы.Скидки.ТекущиеДанные;
	   ПриИзмененииНоменклатураНоменклатурнаяГруппа(ИзмененнаяСтрока);
	   
   КонецПроцедуры

   Добавить журнал документов «ЦеныИСкидки»,в качестве регистрируемых выбрать документы «УстановкаЦен» и «УстановкаСкидок»,добавить графу «Ответственный»

   ![Цены и скидки](%D0%A6%D0%B5%D0%BD%D1%8B%20%D0%B8%20%D1%81%D0%BA%D0%B8%D0%B4%D0%BA%D0%B8.png)